!function(n,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.peasy=t():n.peasy=t()}(this,function(){return function(n){var t={};function e(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return n[r].call(i.exports,i,i.exports,e),i.l=!0,i.exports}return e.m=n,e.c=t,e.d=function(n,t,r){e.o(n,t)||Object.defineProperty(n,t,{enumerable:!0,get:r})},e.r=function(n){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},e.t=function(n,t){if(1&t&&(n=e(n)),8&t)return n;if(4&t&&"object"==typeof n&&n&&n.__esModule)return n;var r=Object.create(null);if(e.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:n}),2&t&&"string"!=typeof n)for(var i in n)e.d(r,i,function(t){return n[t]}.bind(null,i));return r},e.n=function(n){var t=n&&n.__esModule?function(){return n.default}:function(){return n};return e.d(t,"a",t),t},e.o=function(n,t){return Object.prototype.hasOwnProperty.call(n,t)},e.p="",e(e.s=4)}([function(n,t,e){var r=e(1),i=e(2),o=e(3),a=function(){"use strict";var n=function(t){if(t=t||{},!(this instanceof n))return new n(t.onInitialization,t.getRules,t.onValidationSuccess);this._onInitialization||(this._onInitialization=t._onInitialization||function(n,t){return t?t():Promise.resolve()}),this._getRules||(this._getRules=t._getRules||function(n,t){return t?t(null,[]):Promise.resolve([])}),this._onValidationSuccess||(this._onValidationSuccess=t._onValidationSuccess||function(n,t){return t?t():Promise.resolve()})};return n.prototype={constructor:n,execute:function(n){var t={},e=this._onInitialization.bind(this),a=this._getRules.bind(this),s=this._onValidationSuccess.bind(this),u=function(n){return new o(n).validate()},c=function(n){return Promise.resolve(new r(!1,null,n))};n&&(e=d(e),a=d(a),s=d(s),u=function(n){return new Promise((t,e)=>{new o(n).validate(function(r){if(r)return e(r);t(n)})})});var l=e(t).then(function(){return a(t).then(n=>(Array.isArray(n)||(n=[n]),n))}).then(function(n){return u(n)}).then(function(n){var t=n.filter(function(n){return!n.valid}).map(function(n){return n.errors});return[].concat.apply([],t)}).then(function(n){if(n.length>0)return c(n);try{return s(t).then(n=>Promise.resolve(new r(!0,n,null))).catch(f)}catch(n){return f(n)}}).then(t=>n?n(null,t):t).catch(t=>n?n(t):Promise.reject(t));if(!n)return l;function f(n){return n instanceof i?Promise.resolve(new r(!1,null,n.errors)):Promise.reject(n)}function d(n){return function(t){return new Promise((e,r)=>{n(t,function(n,t){if(n)return r(n);e(t)})})}}}},n.extend=function(t){var e=(t=t||{}).params||[],r=t.functions||{},i=function(){var n=this;n.arguments=arguments,e.forEach(function(t,e){n[t]=n.arguments[e]})};return(i.prototype=new n)._onInitialization=r._onInitialization||function(n,t){return t?t():Promise.resolve()},i.prototype._getRules=r._getRules||function(n,t){return t?t(null,[]):Promise.resolve([])},i.prototype._onValidationSuccess=r._onValidationSuccess||function(n,t){return t?t():Promise.resolve()},i},n.executeAll=function(n,t){Array.isArray(n)||(n=[n]);var e=n.length;if(e<1)return t?t():Promise.resolve();if(!t)return Promise.all(n.map(n=>n.execute()));var r=0,i=[];function o(n,o){if(n)return t(n,i);r++,i.push(o),r===e&&t(null,i)}n.forEach(function(n){n.execute(o)})},n}();n.exports=a},function(n,t){var e=function(){"use strict";var n=function(t,e,r){if(!(this instanceof n))return new n(t,e,r);this.success=t,this.value=e,this.errors=r};return n}();n.exports=e},function(n,t){var e=function(n){this.message=n,this.errors=[]};e.prototype=new Error,n.exports=e},function(n,t){var e=function(){"use strict";var n=function(t){if(!(this instanceof n))return new n(t);this.rules=t};return n.prototype.validate=function(n){var t=this,e=t.rules.map(n=>n.validate.bind(n));n&&(e=e.map(n=>(function(n){return function(){return new Promise((t,e)=>{n(function(n,r){if(n)return e(n);t(r)})})}})(n)));var r=Promise.all(e.map(n=>n())).then(()=>n?n(null,t.rules):Promise.resolve(t.rules)).catch(t=>n?n(t):Promise.reject(t));if(!n)return r},n}();n.exports=e},function(n,t,e){var r=e(5),i=e(0),o=e(1),a=e(6),s=e(2);n.exports={BusinessService:r,Command:i,ExecutionResult:o,Rule:a,ServiceException:s}},function(n,t,e){var r=e(0),i=function(){"use strict";var n=function(t){if(!(this instanceof n))return new n(t);this.dataProxy=t};return n.extendService=function(t,e){return e.service=t,n.extend(e)},n.extend=function(t){(t=t||{}).params=t.params||["dataProxy"],t.functions=t.functions||{};var e=function(){var e=this;e.arguments=arguments,n.call(this),t.params.forEach(function(n,t){e[n]=e.arguments[t]})},r=t.service||n;e.prototype=new r;var i=Object.keys(n.prototype);return Object.keys(t.functions).forEach(function(n){-1===i.indexOf(n)&&console.warn("The method: '"+n+"' is not an overridable method of BusinessService"),e.prototype[n]=t.functions[n]}),{createCommand:function t(r){return(r=r||{}).service=e,n.createCommand(r),{createCommand:t,service:e}},service:e}},n.createCommand=function(n){function t(n){return n.charAt(0).toUpperCase()+n.slice(1)}if(!(n=n||{}).name)throw new Error("A value for name must be supplied");if(!n.service)throw new Error("A function for the service argument must be supplied");var e=n.name,i="_on"+t(e)+"Initialization",o="_getRulesFor"+t(e),a="_"+e.replace("Command",""),s="_"+e+"Params",u=n.functions||{},c=n.service;return c.prototype[i]=u._onInitialization||function(n,t){return t?t():Promise.resolve()},c.prototype[o]=u._getRules||function(n,t){return t?t(null,[]):Promise.resolve([])},c.prototype[a]=u._onValidationSuccess||function(n,t){return t?t():Promise.resolve()},c.prototype[s]=n.params||[],c.prototype[e]=function(){var n=this,t=new r({_onInitialization:function(t,e){return n[i].call(this,t,e)},_getRules:function(t,e){return n[o].call(this,t,e)},_onValidationSuccess:function(t,e){return n[a].call(this,t,e)}}),e=arguments;return n[s].forEach(function(n,r){t[n]=e[r]}),Object.keys(n).forEach(e=>{t[e]=n[e]}),t},c},Object.defineProperty(n.prototype,"constructor",{enumerable:!1,value:n}),n.createCommand({name:"getByIdCommand",service:n,params:["id"],functions:{_onValidationSuccess:function(n,t){return t?this.dataProxy.getById(this.id,t):this.dataProxy.getById(this.id)}}}),n.createCommand({name:"getAllCommand",service:n,functions:{_onValidationSuccess:function(n,t){return this.dataProxy.getAll(t)}}}),n.createCommand({name:"insertCommand",service:n,params:["data"],functions:{_onValidationSuccess:function(n,t){return t?this.dataProxy.insert(this.data,t):this.dataProxy.insert(this.data)}}}),n.createCommand({name:"updateCommand",service:n,params:["data"],functions:{_onValidationSuccess:function(n,t){return t?this.dataProxy.update(this.data,t):this.dataProxy.update(this.data)}}}),n.createCommand({name:"destroyCommand",service:n,params:["id"],functions:{_onValidationSuccess:function(n,t){return t?this.dataProxy.destroy(this.id,t):this.dataProxy.destroy(this.id)}}}),n}();n.exports=i},function(n,t,e){var r=e(3),i=function(){"use strict";var n=function(t){if(!(this instanceof n))return new n;t=t||{},this.association=t.association||null,this.errors=[],this.ifInvalidThenFn=null,this.ifValidThenFn=null,this.ifValidThenGetRulesFn=null,this.validSuccessors=[],this.invalidSuccessors=[],this.valid=!0};return n.getAllRulesFrom=function(n,t){return t?e(n,t):new Promise((t,r)=>{e(n,(n,e)=>n?r(n):t(e))});function e(n,t){Array.isArray(n)||(n=[n]);var e=n.length;if(e<1&&t)return t(null,[]);var r=0,i={},o=[];function a(n,i){if(n)return t(n,o);Array.isArray(i)?i.forEach(function(n){o.push(n)}):o.push(i),++r===e&&t(null,o)}n.forEach(n=>{n._getRules(i,a)})}},n.ifAllValid=function(t){return{thenGetRules:function(e){var r=new n;return r._onValidate=function(n){return n?n():Promise.resolve()},r.validSuccessors=t,r.ifValidThenGetRulesFn=e,r}}},n.extend=function(t){if((t=t||{}).functions=t.functions||{},"function"!=typeof t.functions._onValidate)throw new Error("An onValidate method needs to be supplied to execute!");t.association=t.association||null,t.params=t.params||[];var e=function(){var e=this;e.arguments=arguments,n.call(e,{association:t.association}),t.params.forEach(function(n,t){e[n]=e.arguments[t]})};return(e.prototype=new n)._onValidate=t.functions._onValidate,e},n.prototype={constructor:n,_invalidate:function(n){var t=this;this.valid=!1,Array.isArray(n)||(n=[n]),n.forEach(function(n){"string"==typeof n?t.errors.push({association:t.association,message:n}):t.errors.push(n)})},_unInvalidate:function(){this.valid=!0,this.errors=[]},_onValidate:function(n){},validate:function(n){var t=this;return t.errors=[],n?this._onValidate(t=>{if(t)return n(t);e(n)}):this._onValidate().then(e);function e(n){if(t.valid){if(t.ifValidThenFn&&t.ifValidThenFn(),t.validSuccessors.length>0)return function(n,t,e){if(e)return i(n,t,()=>{if(n.ifValidThenGetRulesFn)return o(n,t,e);e()});return i(n,t).then(()=>{if(n.ifValidThenGetRulesFn)return o(n,t)})}(t,t.validSuccessors,n);if(t.ifValidThenGetRulesFn)return o(t,t.validSuccessors,n)}else if(t.ifInvalidThenFn&&t.ifInvalidThenFn(),t.invalidSuccessors.length>0)return i(t,t.invalidSuccessors,n);n&&n()}function i(n,t,e){return e?new r(t).validate(function(r){if(r)return e(r);a(n).ifAnyInvalid(t),e()}):new r(t).validate().then(()=>a(n).ifAnyInvalid(t))}function o(n,t,e){return t.filter(function(n){return!n.valid}).length>0?e?e():Promise.resolve():e?n.ifValidThenGetRulesFn(function(t,r){return Array.isArray(r)||(r=[r]),i(n,r,e)}):n.ifValidThenGetRulesFn().then(t=>(Array.isArray(t)||(t=[t]),i(n,t)))}function a(n){return{ifAnyInvalid:function(t){const e=t.filter(function(n){return!n.valid});e.length>0?e.forEach(function(t){n._invalidate(t.errors)}):n._unInvalidate()}}}},ifValidThenValidate:function(n){return Array.isArray(n)||(n=[n]),this.validSuccessors=n,this},ifValidThenExecute:function(n){return this.ifValidThenFn=n,this},ifInvalidThenValidate:function(n){return Array.isArray(n)||(n=[n]),this.invalidSuccessors=n,this},ifInvalidThenExecute:function(n){return this.ifInvalidThenFn=n,this},ifValidThenGetRules:function(n){return this.ifValidThenGetRulesFn=n,this}},n}();n.exports=i}])});